# 整合页面检测器使用说明

## 概述

整合页面检测器结合了**页面分类器（PyTorch）**和**YOLO模型**，提供了完整的页面识别和元素检测功能。

### 工作流程

```
1. 页面分类器（PyTorch MobileNetV2）
   ↓ 识别页面类型（100%准确率，20-50ms GPU / 50-100ms CPU）
   ↓ 支持GPU加速和INT8量化
   
2. 自动加载对应的YOLO模型
   ↓ 根据页面类型映射
   
3. YOLO模型检测页面元素
   ↓ 检测按钮、输入框等元素
   
4. 返回完整的检测结果
   - 页面类型
   - 页面元素列表
   - 元素位置和置信度
```

## 核心文件

### 1. 页面分类器模型（PyTorch）
- **原始模型**: `page_classifier_pytorch_best.pth` (~14MB)
- **量化模型**: `page_classifier_pytorch_quantized.pth` (~4MB, 可选)
- **类别**: `page_classes.json` (23个页面类型)
- **准确率**: 100%
- **速度**: 
  - GPU: 20-50ms
  - CPU (原始): 50-100ms
  - CPU (量化): 20-40ms (2-4倍加速)

### 2. 模型量化
PyTorch模型支持INT8动态量化，可以显著提升CPU推理速度：

```bash
# 量化模型
python quantize_pytorch_model.py

# 对比性能
python compare_model_performance.py
```

**量化优势**：
- 模型大小减少约75% (14MB → 4MB)
- CPU推理速度提升2-4倍
- 准确率损失<1%
- 内存占用减少约75%

### 2. YOLO模型注册表
- **文件**: `yolo_model_registry.json`
- **内容**: 所有训练好的YOLO模型信息
- **模型数量**: 20+ 个

### 3. 页面-YOLO映射
- **文件**: `page_yolo_mapping.json`
- **内容**: 每个页面类型对应的YOLO模型
- **示例**:
  ```json
  {
    "首页": {
      "yolo_models": [
        {
          "model_key": "homepage",
          "purpose": "检测每日签到按钮和我的按钮"
        }
      ]
    }
  }
  ```

### 4. 整合检测器
- **文件**: `src/page_detector_integrated.py`
- **类**: `PageDetectorIntegrated`

## 使用方法

### 基础使用

```python
from src.adb_bridge import ADBBridge
from src.page_detector_integrated import PageDetectorIntegrated

# 初始化
adb = ADBBridge()
detector = PageDetectorIntegrated(adb)

# 检测页面（只识别页面类型）
result = await detector.detect_page(device_id, detect_elements=False)
print(f"页面类型: {result.state}")
print(f"置信度: {result.confidence:.2%}")

# 检测页面 + 元素
result = await detector.detect_page(device_id, detect_elements=True)
print(f"页面类型: {result.state}")
print(f"检测到的元素: {len(result.elements)}")
for element in result.elements:
    print(f"  - {element.class_name} at {element.center}")
```

### 获取特定元素

```python
# 获取"每日签到按钮"
element = await detector.get_element(device_id, "每日签到按钮")
if element:
    print(f"找到按钮，位置: {element.center}")
    print(f"置信度: {element.confidence:.2%}")
```

### 点击元素

```python
# 点击"每日签到按钮"
success = await detector.click_element(device_id, "每日签到按钮")
if success:
    print("✓ 点击成功")
else:
    print("✗ 未找到按钮")
```

### 使用缓存

```python
# 第一次检测（无缓存）
result1 = await detector.detect_page(device_id, use_cache=False)

# 第二次检测（使用缓存，2秒内）
result2 = await detector.detect_page(device_id, use_cache=True)
print(f"使用缓存: {result2.cached}")
```

## 页面类型和对应的YOLO模型

| 页面类型 | PageState | YOLO模型 | 检测元素 |
|---------|-----------|----------|---------|
| 首页 | HOME | homepage | 每日签到按钮、我的按钮 |
| 登录页 | LOGIN | login | 登陆按钮、输入框、协议勾选框 |
| 签到页 | CHECKIN | checkin | 签到按钮、签到次数 |
| 签到弹窗 | CHECKIN_POPUP | checkin_popup | 签到成功文本、金额、关闭按钮 |
| 个人页_已登录 | PROFILE_LOGGED | profile_logged, balance, avatar_homepage | 昵称、ID、余额、积分、头像、首页按钮 |
| 个人页_未登录 | PROFILE | profile_unlogged | 请登陆按钮 |
| 转账页 | TRANSFER | transfer, transfer_confirm | 全部转账按钮、输入框、提交按钮、确认弹窗 |
| 钱包页 | WALLET | 钱包页 | 余额数字、转增按钮 |
| 温馨提示 | WARMTIP | warmtip | 关闭按钮 |
| 启动页服务弹窗 | STARTUP_POPUP | startup_popup | 同意按钮、拒绝按钮 |
| 首页公告 | HOME_NOTICE | 首页公告 | 确认按钮 |
| 首页异常代码弹窗 | HOME_ERROR_POPUP | 首页异常代码弹窗 | 确认按钮 |
| 个人页广告 | PROFILE_AD | 个人页广告 | 确认按钮 |
| 交易流水 | TRANSACTION_HISTORY | transaction_history | 同意按钮 |
| 优惠劵 | COUPON | coupon_detector | 返回按钮 |
| 分类页 | CATEGORY | 分类页 | 我的按钮、首页按钮 |
| 搜索页 | SEARCH | 搜索页 | 返回按钮 |
| 文章页 | ARTICLE | 文章页 | 返回按钮 |
| 积分页 | POINTS_PAGE | 积分页 | 返回按钮 |
| 设置页 | SETTINGS | - | - |
| 广告页 | AD | - | - |
| 加载页 | LOADING | - | - |
| 模拟器桌面 | LAUNCHER | - | - |

## 测试

运行测试脚本：

```bash
python test_integrated_detector.py
```

测试内容：
1. 检测页面类型（不使用YOLO）
2. 检测页面类型 + 元素（使用YOLO）
3. 获取特定元素
4. 缓存测试

## 性能

### 原始模型（FP32）
- **GPU推理**: 20-50ms
- **CPU推理**: 50-100ms
- **模型大小**: ~14MB
- **准确率**: 100%

### 量化模型（INT8）
- **CPU推理**: 20-40ms (2-4倍加速)
- **模型大小**: ~4MB (减少75%)
- **准确率**: 99%+ (损失<1%)
- **内存占用**: 减少约75%

### YOLO检测
- **推理时间**: 50-200ms（取决于模型复杂度）
- **准确率**: 95%+

### 总耗时
- **GPU + 原始模型**: 70-250ms
- **CPU + 量化模型**: 70-240ms
- **缓存命中**: <1ms

## 性能优化建议

### 1. GPU环境
```python
# 使用原始模型 + GPU
detector = PageDetectorIntegrated(
    adb,
    classifier_model_path='page_classifier_pytorch_best.pth'
)
```

### 2. CPU环境
```python
# 使用量化模型 + CPU
detector = PageDetectorIntegrated(
    adb,
    classifier_model_path='page_classifier_pytorch_quantized.pth'
)
```

### 3. 创建量化模型
```bash
# 量化原始模型
python quantize_pytorch_model.py

# 对比性能
python compare_model_performance.py
```

## 优势

1. **高准确率**: 页面分类100%准确率
2. **快速**: 
   - GPU: 20-50ms
   - CPU量化: 20-40ms (2-4倍加速)
3. **灵活**: 可选择是否使用YOLO检测元素
4. **可扩展**: 易于添加新的页面类型和YOLO模型
5. **智能缓存**: 2秒内重复检测使用缓存
6. **自动映射**: 根据页面类型自动加载对应的YOLO模型
7. **模型量化**: 支持INT8量化，大幅提升CPU性能
8. **跨平台**: 支持GPU和CPU，自动选择最优设备

## 注意事项

1. **GPU加速**: 建议使用GPU以获得最佳性能（20-50ms）
2. **CPU优化**: CPU环境建议使用量化模型（2-4倍加速）
3. **模型文件**: 确保所有模型文件路径正确
4. **缓存时间**: 默认缓存2秒，可根据需要调整
5. **元素检测**: 只在需要时启用YOLO检测以提高速度
6. **量化限制**: 量化模型只能在CPU上运行，不支持GPU

## 模型选择指南

| 环境 | 推荐模型 | 推理时间 | 模型大小 | 准确率 |
|------|---------|---------|---------|--------|
| GPU | 原始模型 (FP32) | 20-50ms | 14MB | 100% |
| CPU (高性能) | 原始模型 (FP32) | 50-100ms | 14MB | 100% |
| CPU (优化) | 量化模型 (INT8) | 20-40ms | 4MB | 99%+ |
| 嵌入式设备 | 量化模型 (INT8) | 20-40ms | 4MB | 99%+ |

## 更新日志

- **2026-01-29**: 
  - 创建整合检测器，支持页面分类器 + YOLO模型
  - 迁移到PyTorch模型（原TensorFlow/Keras）
  - 添加INT8动态量化支持
  - CPU推理速度提升2-4倍
  - 模型大小减少75%
- **准确率**: 页面分类100%（原始）/ 99%+（量化），YOLO检测95%+
- **支持页面**: 23个页面类型
- **支持模型**: 20+ YOLO模型
- **性能优化**: GPU加速 + CPU量化
