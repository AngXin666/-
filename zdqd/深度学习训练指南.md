# 深度学习页面分类器训练指南

## 概述

使用深度学习（卷积神经网络）训练一个页面分类器，可以大幅提升页面识别准确率，解决当前模板匹配的问题。

## 优势

相比传统模板匹配：
- ✅ **更高的准确率** - 可以学习页面的深层特征
- ✅ **更强的泛化能力** - 对页面变化（如内容更新）更鲁棒
- ✅ **自动特征提取** - 不需要手动定义关键区域
- ✅ **支持多分类** - 可以同时识别多种页面类型

## 训练步骤

### 步骤1：安装依赖

```bash
pip install tensorflow pillow
```

### 步骤2：收集训练数据

运行数据收集工具：

```bash
python collect_training_data.py
```

操作流程：
1. 在模拟器中切换到要截图的页面
2. 输入页面类别编号（1-9）
3. 按回车自动截图并保存
4. 重复以上步骤，每个类别收集 **20-50 张截图**

**重要提示**：
- 每个类别至少需要 20 张截图（越多越好）
- 尽量包含不同的页面状态（如不同的商品、不同的时间等）
- 确保截图清晰，分辨率为 540x960

### 步骤3：训练模型

数据收集完成后，运行训练脚本：

```bash
python train_page_classifier.py
```

训练过程：
- 模型会自动构建（使用 MobileNetV2 作为基础）
- 数据会自动分为训练集（80%）和验证集（20%）
- 训练大约需要 10-20 分钟（取决于数据量和硬件）
- 最佳模型会自动保存为 `page_classifier.h5`

### 步骤4：集成到项目

训练完成后，修改 `src/page_detector_hybrid.py`，添加深度学习检测：

```python
# 在 PageDetectorHybrid 类中添加
def __init__(self, adb: ADBBridge, log_callback=None):
    # ... 现有代码 ...
    
    # 加载深度学习模型
    try:
        from train_page_classifier import PageClassifier
        self.dl_classifier = PageClassifier()
        self.dl_classifier.load_model('page_classifier.h5')
        print("[深度学习] ✓ 模型加载成功")
    except Exception as e:
        print(f"[深度学习] ⚠️ 模型加载失败: {e}")
        self.dl_classifier = None

async def detect_page(self, device_id: str, use_ocr: bool = False, use_template: bool = True) -> PageDetectionResult:
    # 策略0: 深度学习检测（最准确）
    if self.dl_classifier:
        try:
            screenshot_data = await self.adb.screencap(device_id)
            if screenshot_data:
                # 保存临时文件
                import tempfile
                with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as f:
                    f.write(screenshot_data)
                    temp_path = f.name
                
                # 预测
                page_type, confidence = self.dl_classifier.predict(temp_path)
                
                # 删除临时文件
                import os
                os.unlink(temp_path)
                
                if confidence >= 0.8:  # 置信度阈值
                    print(f"[深度学习] ✓ {page_type} (置信度: {confidence:.2%})")
                    # 转换为 PageState
                    # ... 映射逻辑 ...
        except Exception as e:
            print(f"[深度学习] ⚠️ 预测失败: {e}")
    
    # 降级到模板匹配和OCR
    # ... 现有代码 ...
```

## 页面类别

当前支持的页面类别：

1. **首页** - 应用主页，有"每日签到"按钮
2. **个人页_已登录** - 个人中心，已登录状态
3. **个人页_未登录** - 个人中心，未登录状态
4. **签到页** - 每日签到/抽奖页面
5. **登录页** - 登录界面
6. **广告页** - 启动广告
7. **弹窗** - 各种弹窗（公告、提示等）
8. **加载页** - 加载中的白屏
9. **其他** - 其他页面

## 数据集目录结构

```
training_data/
├── 首页/
│   ├── 首页_20260126_180000_123456.png
│   ├── 首页_20260126_180010_234567.png
│   └── ...
├── 个人页_已登录/
│   ├── 个人页_已登录_20260126_180020_345678.png
│   └── ...
├── 签到页/
│   └── ...
└── ...
```

## 模型架构

- **基础模型**: MobileNetV2（预训练在 ImageNet）
- **输入大小**: 224x224x3
- **输出**: 9个类别的概率分布
- **优化器**: Adam (learning_rate=0.001)
- **损失函数**: Categorical Crossentropy

## 训练技巧

1. **数据增强** - 自动应用水平翻转、旋转、缩放
2. **早停** - 验证损失不再下降时自动停止
3. **学习率衰减** - 自动降低学习率
4. **保存最佳模型** - 自动保存验证准确率最高的模型

## 性能预期

根据经验：
- **训练准确率**: 95%+
- **验证准确率**: 90%+
- **推理速度**: ~50ms/张（CPU）
- **模型大小**: ~10MB

## 故障排除

### 问题1：TensorFlow 安装失败

```bash
# Windows
pip install tensorflow-cpu

# 或使用清华镜像
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple tensorflow
```

### 问题2：内存不足

- 减少 batch_size（在 `prepare_dataset` 中）
- 使用更小的图片尺寸（如 128x128）

### 问题3：训练速度慢

- 使用 GPU 版本的 TensorFlow
- 减少训练轮数（epochs）
- 使用更小的模型（如 MobileNetV3-Small）

## 下一步优化

1. **增加数据量** - 每个类别收集 100+ 张截图
2. **微调基础模型** - 解冻部分层进行微调
3. **使用更大的模型** - 如 EfficientNet
4. **集成到生产环境** - 替换现有的模板匹配

## 总结

深度学习方法可以显著提升页面识别准确率，但需要：
- ✅ 收集足够的训练数据（每类 20-50 张）
- ✅ 安装 TensorFlow（~500MB）
- ✅ 训练时间（10-20 分钟）

如果数据量不足或不想安装 TensorFlow，可以继续使用模板匹配，但需要：
- 重新截取更准确的模板
- 定期更新模板以适应界面变化


---

# 目标检测模型训练（YOLO）

## 概述

使用 YOLO（You Only Look Once）训练目标检测模型，可以自动检测页面中的按钮和元素位置，无需手动配置坐标。

## 优势

相比手动配置坐标：
- ✅ **自动定位** - 自动检测按钮位置，无需手动配置
- ✅ **适应变化** - 对界面布局变化有更强的适应能力
- ✅ **多目标检测** - 可以同时检测多个按钮
- ✅ **置信度评分** - 提供检测置信度，便于判断

## 训练步骤

### 步骤1：安装 YOLO

```bash
pip install ultralytics
```

### 步骤2：标注数据

运行标注工具：

```bash
python annotation_tool.py
```

操作流程：
1. 选择页面类别（如"启动页服务弹窗"）
2. 选择元素类别（如"同意按钮"）
3. 鼠标拖动框选按钮位置
4. 标注 5-10 张后按 `Ctrl+S` 保存
5. 按空格键切换到下一张图片
6. 重复以上步骤

**标注数量建议**：
- **固定位置元素**（按钮、数字位置固定）：10 张
- **动态布局页面**（内容位置可能变化）：20-30 张

**快捷键**：
- `鼠标拖动`: 框选元素
- `空格`: 下一张
- `Backspace`: 上一张
- `Delete`: 删除最后一个标注
- `Ctrl+S`: 保存
- `H`: 显示/隐藏已保存标注
- `1-9`: 快速选择元素类别

**元素类别**：
1. 同意按钮
2. 拒绝按钮
3. 确认按钮
4. 关闭按钮
5. 跳过按钮
6. 返回按钮
7. 签到按钮
8. 转账按钮
9. 余额数字
10. 积分数字
11. 昵称文本
12. 用户ID
13. 其他

### 步骤3：训练 YOLO 模型

标注完成后，运行训练脚本：

```bash
python train_yolo_detector.py
```

训练过程：
- 自动准备 YOLO 数据集（80% 训练，20% 验证）
- 使用 YOLOv8n（最小最快的模型）
- 训练 100 轮（可根据需要调整）
- 最佳模型保存为 `yolo_runs/button_detector/weights/best.pt`

**训练参数**：
- `epochs`: 训练轮数（默认 100）
- `imgsz`: 图片大小（默认 640）
- `batch`: 批次大小（默认 16）
- `device`: 设备（'cpu' 或 0 表示 GPU）

### 步骤4：测试模型

训练完成后，测试模型：

```bash
# 测试单张图片
python test_yolo_detector.py path/to/image.png

# 测试整个目录
python test_yolo_detector.py path/to/directory/

# 交互式测试
python test_yolo_detector.py
```

### 步骤5：集成到项目

在项目中使用训练好的模型：

```python
from ultralytics import YOLO

# 加载模型
model = YOLO('yolo_runs/button_detector/weights/best.pt')

# 检测按钮
results = model.predict(
    source='screenshot.png',
    conf=0.25,  # 置信度阈值
    verbose=False
)

# 获取检测结果
for result in results:
    boxes = result.boxes
    for box in boxes:
        cls = int(box.cls[0])
        conf = float(box.conf[0])
        x1, y1, x2, y2 = box.xyxy[0].tolist()
        
        class_name = result.names[cls]
        center_x = (x1 + x2) / 2
        center_y = (y1 + y2) / 2
        
        print(f"检测到 {class_name} at ({center_x}, {center_y}), 置信度: {conf:.2f}")
        
        # 点击按钮
        # adb.tap(device_id, int(center_x), int(center_y))
```

## 数据集结构

标注工具会自动生成两种格式：

### JSON 格式（annotations.json）
```json
{
  "training_data/启动页服务弹窗/1.png": [
    {
      "class": "同意按钮",
      "x1": 100,
      "y1": 200,
      "x2": 200,
      "y2": 250
    }
  ]
}
```

### YOLO 格式（.txt）
```
0 0.277778 0.520833 0.185185 0.052083
```
格式：`class_id center_x center_y width height`（归一化坐标）

## 模型架构

- **模型**: YOLOv8n（Nano）
- **参数量**: ~3M
- **速度**: ~100 FPS（GPU）
- **精度**: mAP50 通常 > 90%

## 训练技巧

1. **数据增强** - YOLO 自动应用数据增强
2. **早停** - 使用 `patience=20` 避免过拟合
3. **多尺度训练** - 自动使用多尺度训练
4. **迁移学习** - 使用预训练权重加速训练

## 性能预期

根据经验：
- **mAP50**: 90%+（固定位置按钮）
- **mAP50-95**: 70%+
- **推理速度**: ~20ms/张（CPU）
- **模型大小**: ~6MB

## 标注建议

### 重要说明

**标注工具已经知道页面类型**：
- 图片按页面分类存储在 `training_data/页面名称/` 目录
- 标注时选择的页面类别就是页面类型
- 训练时会自动记录每张图片属于哪个页面
- 生成 `yolo_dataset/page_mapping.json` 文件保存页面映射

### 标注流程

1. **选择页面类别**（如"个人页_已登录"）
2. **标注该页面的元素**（如"昵称文本"、"用户ID"）
3. **保存标注**（Ctrl+S）
4. **切换到下一张图片**（空格键）

### 页面-元素对应关系

训练脚本会自动：
- 读取图片所在目录名称作为页面类型
- 统计每个页面类型的标注数量
- 生成页面映射文件
- 在检测时根据页面类型过滤元素

### 固定位置元素（10 张）

**按钮类**：
- 启动页服务弹窗（同意/拒绝按钮）
- 温馨提示（确认/关闭按钮）
- 签到弹窗（确认按钮）
- 首页公告（关闭按钮）
- 手机号码不存在（关闭按钮）
- 用户名或密码错误（确认按钮）
- 签到按钮
- 转账按钮
- 返回按钮

**数字/文本类**：
- 钱包页余额数字（位置固定）
- 积分页积分数字（位置固定）
- 个人页昵称文本（位置固定）
- 个人页用户ID（位置固定）

### 动态布局页面（20-30 张）
- 首页（内容更新，布局可能变化）
- 商品列表（商品位置不固定）
- 搜索结果（结果数量和位置变化）

### 完整标注清单

根据你的 24 个页面类别，建议标注以下元素：

| 页面类别 | 需要标注的元素 | 数量 |
|---------|--------------|------|
| 启动页服务弹窗 | 同意按钮、拒绝按钮 | 10 |
| 温馨提示 | 确认按钮、关闭按钮 | 10 |
| 签到弹窗 | 确认按钮 | 10 |
| 首页公告 | 关闭按钮 | 10 |
| 手机号码不存在 | 关闭按钮 | 10 |
| 用户名或密码错误弹窗 | 确认按钮 | 10 |
| 签到页 | 签到按钮 | 10 |
| 钱包页 | 余额数字、转账按钮 | 10 |
| 转账页 | 确认按钮、返回按钮 | 10 |
| 积分页 | 积分数字、返回按钮 | 10 |
| 个人页_已登录 | 昵称文本、用户ID | 10 |
| 设置 | 返回按钮 | 10 |

**预计工作量**：约 2-3 小时

### 标注质量要求
- ✅ 框选要紧贴按钮边缘
- ✅ 不要框选过大或过小
- ✅ 确保类别选择正确
- ✅ 同一页面的相同按钮要标注一致

## 故障排除

### 问题1：检测不准确

- 增加标注数量（每类至少 20 张）
- 检查标注质量（框选是否准确）
- 增加训练轮数（epochs）
- 降低置信度阈值（conf）

### 问题2：训练速度慢

- 使用 GPU（`device=0`）
- 减少图片大小（`imgsz=320`）
- 使用更小的批次（`batch=8`）

### 问题3：模型过拟合

- 增加数据量
- 使用数据增强
- 减少训练轮数
- 使用早停（patience）

## 与页面分类结合

**重要**：YOLO 训练时不知道元素属于哪个页面，所以需要结合页面分类使用。

### 两阶段检测方案（推荐）✅

**流程**：
```
截图 → 页面分类 → 根据页面类型 → YOLO检测对应元素
```

**实现**：
```python
from detect_page_elements import PageElementDetector

# 1. 创建检测器
detector = PageElementDetector(
    page_classifier_path="page_classifier.h5",
    yolo_model_path="yolo_runs/button_detector/weights/best.pt"
)

# 2. 检测页面元素
result = detector.detect("screenshot.png")

# 输出：
# 页面类型: 个人页_已登录 (置信度: 95%)
# 应检测元素: ['昵称文本', '用户ID']
#   ✓ 昵称文本: (270, 180), 置信度: 92%
#   ✓ 用户ID: (380, 310), 置信度: 88%

# 3. 查找并点击元素
found, pos = detector.detect_and_click("screenshot.png", "同意按钮")
if found:
    adb.tap(device_id, pos[0], pos[1])
```

### 页面-元素映射

已创建 `page_element_mapping.py` 配置文件，定义每个页面应该检测哪些元素：

```python
PAGE_ELEMENT_MAPPING = {
    "启动页服务弹窗": ["同意按钮", "拒绝按钮"],
    "个人页_已登录": ["昵称文本", "用户ID"],
    "钱包页": ["余额数字", "转账按钮"],
    "签到页": ["签到按钮"],
    # ... 更多
}
```

### 优势

- ✅ **避免误检测** - 钱包页不会误检测出"昵称文本"
- ✅ **提高准确率** - 只在相关页面检测对应元素
- ✅ **减少计算量** - 不需要检测所有类别
- ✅ **易于维护** - 页面-元素映射清晰明确

### 使用文件

1. **page_element_mapping.py** - 页面-元素映射配置
2. **detect_page_elements.py** - 集成检测示例
3. **train_page_classifier.py** - 页面分类训练
4. **train_yolo_detector.py** - YOLO目标检测训练

最佳实践：
1. **页面分类** - 先用深度学习识别当前页面
2. **元素过滤** - 根据页面类型，只检测对应元素
3. **目标检测** - 用 YOLO 检测元素位置
4. **执行操作** - 点击检测到的元素

```python
# 完整流程示例
# 1. 识别页面
page_type, conf = page_classifier.predict(screenshot)

# 2. 根据页面类型检测元素
if page_type == "启动页服务弹窗":
    # 只检测同意和拒绝按钮
    results = yolo_model.predict(screenshot, classes=[0, 1])
    
    # 3. 查找"同意按钮"
    for box in results[0].boxes:
        if results[0].names[int(box.cls[0])] == "同意按钮":
            x1, y1, x2, y2 = box.xyxy[0].tolist()
            center_x = (x1 + x2) / 2
            center_y = (y1 + y2) / 2
            
            # 4. 点击按钮
            adb.tap(device_id, int(center_x), int(center_y))
            break
```

## 总结

YOLO 目标检测可以自动定位按钮，但需要：
- ✅ 标注数据（每类 10-30 张）
- ✅ 训练时间（30-60 分钟）
- ✅ 安装 ultralytics（~200MB）

优势：
- 🚀 自动定位，无需手动配置坐标
- 🚀 适应界面变化
- 🚀 提供置信度评分

适用场景：
- ✅ 按钮位置经常变化的页面
- ✅ 需要检测多个按钮的页面
- ✅ 界面布局不固定的页面
