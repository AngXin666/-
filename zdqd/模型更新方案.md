# æ¨¡å‹æ›´æ–°æ–¹æ¡ˆ - å¤šç”¨æˆ·éƒ¨ç½²ï¼ˆæœ¬åœ°æ–¹å¼ï¼‰

## é—®é¢˜åˆ†æ

å½“å‰ç¨‹åºå°†æ¨¡å‹æ–‡ä»¶ç›´æ¥æ‰“åŒ…åˆ°EXEä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **æ¨¡å‹æ›´æ–°å›°éš¾**ï¼šæ¯æ¬¡æ›´æ–°æ¨¡å‹éƒ½éœ€è¦é‡æ–°æ‰“åŒ…æ•´ä¸ªEXE
2. **æ–‡ä»¶ä½“ç§¯å¤§**ï¼šæ¨¡å‹æ–‡ä»¶è¾ƒå¤§ï¼Œå¯¼è‡´EXEä½“ç§¯è¿‡å¤§
3. **æ— æ³•çƒ­æ›´æ–°**ï¼šç”¨æˆ·å¿…é¡»ä¸‹è½½æ–°çš„EXEæ‰èƒ½ä½¿ç”¨æ–°æ¨¡å‹
4. **ç‰ˆæœ¬ç®¡ç†æ··ä¹±**ï¼šæ¨¡å‹ç‰ˆæœ¬å’Œç¨‹åºç‰ˆæœ¬è€¦åˆåœ¨ä¸€èµ·

## è§£å†³æ–¹æ¡ˆï¼šæœ¬åœ°æ¨¡å‹æ–‡ä»¶å¤¹ï¼ˆçº¯æœ¬åœ°æ–¹å¼ï¼‰

### æ ¸å¿ƒæ€è·¯ï¼šæ¨¡å‹å¤–ç½® + æ‰‹åŠ¨æ›¿æ¢

#### 1.1 ç›®å½•ç»“æ„
```
è‡ªåŠ¨ç­¾åˆ°åŠ©æ‰‹_v2.0.6.exe
â”œâ”€â”€ models/                          # æ¨¡å‹æ–‡ä»¶å¤¹ï¼ˆå¤–ç½®ï¼Œå¯å•ç‹¬æ›¿æ¢ï¼‰
â”‚   â”œâ”€â”€ page_classifier_pytorch_best.pth
â”‚   â”œâ”€â”€ page_classes.json
â”‚   â”œâ”€â”€ yolo_runs/
â”‚   â”‚   â”œâ”€â”€ login_detector/
â”‚   â”‚   â”‚   â””â”€â”€ weights/
â”‚   â”‚   â”‚       â””â”€â”€ best.pt
â”‚   â”‚   â”œâ”€â”€ warmtip_detector/
â”‚   â”‚   â”‚   â””â”€â”€ train2/
â”‚   â”‚   â”‚       â””â”€â”€ weights/
â”‚   â”‚   â”‚           â””â”€â”€ best.pt
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ yolo_model_registry.json
â”‚   â”œâ”€â”€ page_yolo_mapping.json
â”‚   â””â”€â”€ model_version.json          # æ¨¡å‹ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ dist/
â”‚   â””â”€â”€ JT/                          # æ¨¡æ¿æ–‡ä»¶ï¼ˆåŠ å¯†ï¼‰
â”œâ”€â”€ runtime_data/
â”‚   â””â”€â”€ license.db
â”œâ”€â”€ .env
â””â”€â”€ è´¦å·.txt
```

#### 1.2 æ¨¡å‹ç‰ˆæœ¬ç®¡ç†ï¼ˆå¯é€‰ï¼‰

åˆ›å»º `models/model_version.json` ç”¨äºè®°å½•ç‰ˆæœ¬ï¼š
```json
{
  "version": "1.0.0",
  "update_date": "2026-01-30",
  "description": "åˆå§‹ç‰ˆæœ¬",
  "models": {
    "page_classifier": {
      "version": "1.0.0",
      "file": "page_classifier_pytorch_best.pth",
      "description": "é¡µé¢åˆ†ç±»å™¨"
    },
    "login_detector": {
      "version": "1.0.0",
      "file": "yolo_runs/login_detector/weights/best.pt",
      "description": "ç™»å½•é¡µæ£€æµ‹å™¨"
    }
  }
}
```

#### 1.3 æ¨¡å‹åŠ è½½é€»è¾‘ä¿®æ”¹

ä¿®æ”¹ `src/model_manager.py`ï¼Œæ”¯æŒä»å¤–éƒ¨æ–‡ä»¶å¤¹åŠ è½½ï¼š

```python
import os
import sys
from pathlib import Path

class ModelManager:
    def __init__(self):
        # ç¡®å®šæ¨¡å‹ç›®å½•
        if getattr(sys, 'frozen', False):
            # æ‰“åŒ…åçš„EXEç¯å¢ƒ
            self.base_dir = Path(sys.executable).parent
        else:
            # å¼€å‘ç¯å¢ƒ
            self.base_dir = Path(__file__).parent.parent
        
        # æ¨¡å‹ç›®å½•ï¼ˆå¤–ç½®ï¼‰
        self.models_dir = self.base_dir / "models"
        
        # ç¡®ä¿æ¨¡å‹ç›®å½•å­˜åœ¨
        if not self.models_dir.exists():
            raise FileNotFoundError(
                f"æ¨¡å‹ç›®å½•ä¸å­˜åœ¨: {self.models_dir}\n"
                f"è¯·ç¡®ä¿ models æ–‡ä»¶å¤¹ä¸ç¨‹åºåœ¨åŒä¸€ç›®å½•ä¸‹"
            )
    
    def _load_page_detector_integrated(self):
        """åŠ è½½é¡µé¢åˆ†ç±»å™¨"""
        model_path = self.models_dir / "page_classifier_pytorch_best.pth"
        classes_path = self.models_dir / "page_classes.json"
        
        if not model_path.exists():
            raise FileNotFoundError(f"æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {model_path}")
        
        # åŠ è½½æ¨¡å‹...
```

#### 1.4 æ¨¡å‹æ›´æ–°æµç¨‹ï¼ˆçº¯æœ¬åœ°æ–¹å¼ï¼‰

**æ–¹å¼ï¼šæ‰‹åŠ¨æ›¿æ¢**

1. **è®­ç»ƒæ–°æ¨¡å‹**
   ```bash
   # è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹ä¿å­˜åœ¨ runs/detect/yolo_runs/xxx/weights/best.pt
   python train_xxx_yolo.py
   ```

2. **æ•´ç†æ–°æ¨¡å‹**
   ```bash
   # åˆ›å»ºæ–°ç‰ˆæœ¬çš„modelsæ–‡ä»¶å¤¹
   mkdir models_v1.0.1
   
   # å¤åˆ¶æ‰€æœ‰æ¨¡å‹æ–‡ä»¶
   copy models\*.pth models_v1.0.1\
   copy models\*.json models_v1.0.1\
   
   # æ›¿æ¢æ›´æ–°çš„æ¨¡å‹
   copy runs\detect\yolo_runs\xxx\weights\best.pt models_v1.0.1\yolo_runs\xxx\weights\
   
   # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
   # ç¼–è¾‘ models_v1.0.1\model_version.json
   ```

3. **æ‰“åŒ…å‘å¸ƒ**
   ```bash
   # æ–¹å¼Aï¼šå®Œæ•´åŒ…ï¼ˆåŒ…å«EXEå’Œmodelsï¼‰
   # é€‚åˆæ–°ç”¨æˆ·æˆ–å¤§ç‰ˆæœ¬æ›´æ–°
   release\
   â”œâ”€â”€ è‡ªåŠ¨ç­¾åˆ°åŠ©æ‰‹_v2.0.6.exe
   â”œâ”€â”€ models\
   â”œâ”€â”€ .env.example
   â””â”€â”€ README.txt
   
   # æ–¹å¼Bï¼šæ¨¡å‹æ›´æ–°åŒ…ï¼ˆåªåŒ…å«modelsï¼‰
   # é€‚åˆè€ç”¨æˆ·ï¼Œåªæ›´æ–°æ¨¡å‹
   models_update_v1.0.1\
   â”œâ”€â”€ models\
   â””â”€â”€ æ›´æ–°è¯´æ˜.txt
   ```

4. **ç”¨æˆ·æ›´æ–°**
   - **å®Œæ•´åŒ…**ï¼šè§£å‹åç›´æ¥ä½¿ç”¨
   - **æ›´æ–°åŒ…**ï¼š
     1. å…³é—­ç¨‹åº
     2. å¤‡ä»½æ—§çš„modelsæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰
     3. ç”¨æ–°çš„modelsæ–‡ä»¶å¤¹æ›¿æ¢æ—§çš„
     4. é‡å¯ç¨‹åº

## å®æ–½æ­¥éª¤ï¼ˆçº¯æœ¬åœ°æ–¹å¼ï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šæ¨¡å‹å¤–ç½®ï¼ˆç«‹å³å®æ–½ï¼‰

1. **ä¿®æ”¹ç›®å½•ç»“æ„**
   ```bash
   # åˆ›å»ºmodelsç›®å½•
   mkdir models
   
   # ç§»åŠ¨æ¨¡å‹æ–‡ä»¶
   move *.pth models\
   move page_classes.json models\
   move yolo_model_registry.json models\
   move page_yolo_mapping.json models\
   move yolo_runs models\
   move runs models\
   ```

2. **ä¿®æ”¹model_manager.py**
   - æ·»åŠ æ¨¡å‹ç›®å½•æ£€æµ‹
   - æ”¯æŒä»å¤–éƒ¨ç›®å½•åŠ è½½
   - æ·»åŠ å‹å¥½çš„é”™è¯¯æç¤º

3. **ä¿®æ”¹æ„å»ºè„šæœ¬**
   ```bat
   REM ä¸å†æ‰“åŒ…æ¨¡å‹æ–‡ä»¶åˆ°EXE
   REM åªæ‰“åŒ…ç¨‹åºä»£ç å’Œæ¨¡æ¿æ–‡ä»¶
   
   pyinstaller --onefile --windowed ^
     --name="è‡ªåŠ¨ç­¾åˆ°åŠ©æ‰‹_v2.0.6" ^
     --add-data "C:\Program Files\Python311\Lib\site-packages\rapidocr;rapidocr" ^
     --add-data "dist/JT;dist/JT" ^
     run.py
   
   REM æ„å»ºåå¤åˆ¶modelsç›®å½•åˆ°dist
   xcopy /E /I /Y /Q "models" "dist\models"
   ```

4. **åˆ›å»ºå‘å¸ƒåŒ…**
   ```
   è‡ªåŠ¨ç­¾åˆ°åŠ©æ‰‹_v2.0.6_å‘å¸ƒåŒ…/
   â”œâ”€â”€ è‡ªåŠ¨ç­¾åˆ°åŠ©æ‰‹_v2.0.6.exe
   â”œâ”€â”€ models/                    # æ¨¡å‹æ–‡ä»¶å¤¹
   â”‚   â”œâ”€â”€ [æ‰€æœ‰æ¨¡å‹æ–‡ä»¶]
   â”‚   â””â”€â”€ model_version.json    # å¯é€‰
   â”œâ”€â”€ .env.example
   â”œâ”€â”€ è´¦å·.txt.example
   â””â”€â”€ README.txt                 # ä½¿ç”¨è¯´æ˜
   ```

### ç¬¬äºŒé˜¶æ®µï¼šç‰ˆæœ¬ç®¡ç†ï¼ˆå¯é€‰ï¼‰

1. **åˆ›å»ºmodel_version.json**
   ```bash
   python tools/generate_model_version.py --version 1.0.0
   ```

2. **åœ¨GUIä¸­æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯**
   - æ·»åŠ "æ¨¡å‹ä¿¡æ¯"æŒ‰é’®
   - æ˜¾ç¤ºå½“å‰æ¨¡å‹ç‰ˆæœ¬
   - æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨

## ç”¨æˆ·ä½¿ç”¨æµç¨‹

### é¦–æ¬¡å®‰è£…
1. ä¸‹è½½å‘å¸ƒåŒ…ï¼ˆåŒ…å«EXEå’Œmodelsæ–‡ä»¶å¤¹ï¼‰
2. è§£å‹åˆ°ä»»æ„ç›®å½•
3. è¿è¡ŒEXEï¼Œç¨‹åºè‡ªåŠ¨æ£€æµ‹modelsæ–‡ä»¶å¤¹
4. æ­£å¸¸ä½¿ç”¨

### æ¨¡å‹æ›´æ–°ï¼ˆæ‰‹åŠ¨æ–¹å¼ï¼‰

**å®Œæ•´æ›´æ–°åŒ…ï¼ˆé€‚åˆæ–°ç”¨æˆ·ï¼‰**
1. ä¸‹è½½æ–°ç‰ˆæœ¬å®Œæ•´åŒ…
2. è§£å‹åˆ°æ–°ç›®å½•
3. å¤åˆ¶æ—§ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶ï¼ˆ.envã€è´¦å·.txtç­‰ï¼‰
4. è¿è¡Œæ–°ç‰ˆæœ¬

**æ¨¡å‹æ›´æ–°åŒ…ï¼ˆé€‚åˆè€ç”¨æˆ·ï¼‰**
1. ä¸‹è½½æ¨¡å‹æ›´æ–°åŒ…ï¼ˆåªåŒ…å«modelsæ–‡ä»¶å¤¹ï¼‰
2. å…³é—­ç¨‹åº
3. å¤‡ä»½æ—§çš„modelsæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰
   ```bash
   rename models models_backup_20260130
   ```
4. è§£å‹æ–°çš„modelsæ–‡ä»¶å¤¹åˆ°ç¨‹åºç›®å½•
5. é‡å¯ç¨‹åº

### æ¨¡å‹å›æ»šï¼ˆå¦‚æœæ–°æ¨¡å‹æœ‰é—®é¢˜ï¼‰
1. å…³é—­ç¨‹åº
2. åˆ é™¤æ–°çš„modelsæ–‡ä»¶å¤¹
3. æ¢å¤å¤‡ä»½çš„modelsæ–‡ä»¶å¤¹
   ```bash
   rename models_backup_20260130 models
   ```
4. é‡å¯ç¨‹åº

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šç¡®ä¿æ–°æ¨¡å‹ä¸æ—§ç‰ˆæœ¬ç¨‹åºå…¼å®¹
2. **é”™è¯¯å¤„ç†**ï¼šæ¨¡å‹åŠ è½½å¤±è´¥æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
3. **æ–‡ä»¶æƒé™**ï¼šç¡®ä¿ç¨‹åºæœ‰æƒé™è¯»å†™modelsç›®å½•
4. **ç£ç›˜ç©ºé—´**ï¼šæ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
5. **å¤‡ä»½æé†’**ï¼šå»ºè®®ç”¨æˆ·åœ¨æ›´æ–°å‰å¤‡ä»½æ—§æ¨¡å‹

## å¼€å‘å·¥å…·

åˆ›å»ºæ¨¡å‹ç®¡ç†å·¥å…·ï¼š

```bash
# ç”Ÿæˆç‰ˆæœ¬æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
python tools/generate_model_version.py --version 1.0.1

# æ‰“åŒ…æ¨¡å‹æ›´æ–°åŒ…
python tools/pack_models.py --version 1.0.1 --output models_update_v1.0.1.zip

# éªŒè¯æ¨¡å‹æ–‡ä»¶
python tools/verify_models.py --dir models/
```

## æ€»ç»“

**æ¨èæ–¹æ¡ˆ**ï¼šçº¯æœ¬åœ°æ–¹å¼ï¼ˆæ¨¡å‹å¤–ç½® + æ‰‹åŠ¨æ›¿æ¢ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹æ›´æ–°ç®€å•ï¼ˆåªéœ€æ›¿æ¢æ–‡ä»¶å¤¹ï¼‰
- âœ… EXEä½“ç§¯å°ï¼ˆä¸åŒ…å«æ¨¡å‹ï¼‰
- âœ… æ— éœ€ç½‘ç»œè¿æ¥
- âœ… ç”¨æˆ·å®Œå…¨æ§åˆ¶
- âœ… æ”¯æŒç‰ˆæœ¬å›æ»š
- âœ… å®æ–½ç®€å•å¿«é€Ÿ

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ‰‹åŠ¨ä¸‹è½½å’Œæ›¿æ¢
- âš ï¸ ç”¨æˆ·éœ€è¦çŸ¥é“å¦‚ä½•æ“ä½œæ–‡ä»¶å¤¹

**å®æ–½ä¼˜å…ˆçº§**ï¼š
1. ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼šæ¨¡å‹å¤–ç½®ï¼ˆç«‹å³å®æ–½ï¼‰
2. ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼šç‰ˆæœ¬ç®¡ç†ï¼ˆå¯é€‰ï¼‰
3. ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼šGUIæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
