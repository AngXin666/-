# 转账目标模式使用指南

## 功能说明

系统现在支持三种转账目标模式，让你可以灵活选择转账给谁：

### 模式1：转给管理员自己 (`manager_account`)
- **说明**：账号的余额转给该账号的管理员的其他账号
- **适用场景**：想把所有账号的余额集中到管理员的某个账号上
- **示例**：
  - 管理员A有3个账号：账号1、账号2、账号3
  - 账号1的余额会转给账号2或账号3（轮询选择）
  - 自动过滤掉自己，避免自己转给自己

### 模式2：转给管理员的收款人 (`manager_recipients`) **【默认】**
- **说明**：账号的余额转给管理员配置的收款人列表
- **适用场景**：每个管理员有自己的收款账号，想把余额转给指定的收款人
- **示例**：
  - 管理员A配置了收款人：13900139000、14000140000
  - 管理员A的所有账号余额会转给这两个收款人（轮询选择）

### 模式3：转给系统配置收款人 (`system_recipients`)
- **说明**：所有账号的余额都转给系统配置文件中的收款人
- **适用场景**：统一管理，所有账号都转给同一批收款人
- **示例**：
  - 系统配置了收款人：15000150000、16000160000
  - 所有账号的余额都会转给这两个收款人（轮询选择）

## 配置方法

### 方法1：修改配置文件

编辑 `transfer_config.json` 文件：

```json
{
  "min_balance": 0.0,
  "min_transfer_amount": 30.0,
  "recipient_ids": ["13900139000", "14000140000"],
  "enabled": true,
  "use_user_manager_recipients": true,
  "transfer_target_mode": "manager_recipients"
}
```

**`transfer_target_mode` 可选值：**
- `"manager_account"` - 转给管理员自己
- `"manager_recipients"` - 转给管理员的收款人（默认）
- `"system_recipients"` - 转给系统配置收款人

### 方法2：使用代码设置

```python
from src.transfer_config import get_transfer_config

config = get_transfer_config()

# 设置模式
config.set_transfer_target_mode("manager_account")  # 转给管理员自己
# 或
config.set_transfer_target_mode("manager_recipients")  # 转给管理员的收款人
# 或
config.set_transfer_target_mode("system_recipients")  # 转给系统配置收款人

# 获取当前模式的显示名称
print(config.get_transfer_target_mode_display())
```

## 优先级和降级机制

系统会根据配置自动选择收款人，如果某个模式无法找到收款人，会自动降级：

### 模式1：转给管理员自己
1. 尝试从管理员的账号列表中选择（过滤掉发送人自己）
2. 如果管理员没有其他账号 → **降级到系统配置收款人**

### 模式2：转给管理员的收款人
1. 尝试从管理员配置的收款人列表中选择
2. 如果管理员未配置收款人 → **降级到系统配置收款人**

### 模式3：转给系统配置收款人
1. 直接使用系统配置的收款人
2. 如果系统未配置收款人 → **无法转账**

## 测试方法

运行测试脚本：

```bash
cd zdqd
python test_transfer_target_mode.py
```

测试脚本会：
1. 显示配置文件示例
2. 测试三种模式的收款人选择
3. 显示每种模式选中的收款人

## 使用建议

### 场景1：多个管理员，各自管理自己的账号
- **推荐模式**：`manager_recipients`（默认）
- **配置**：每个管理员在用户管理中配置自己的收款人
- **优点**：灵活，每个管理员独立管理

### 场景2：集中管理，所有余额汇总到几个主账号
- **推荐模式**：`system_recipients`
- **配置**：在 `transfer_config.json` 中配置统一的收款人
- **优点**：简单，统一管理

### 场景3：管理员想把余额集中到自己的某个账号
- **推荐模式**：`manager_account`
- **配置**：确保管理员有多个账号
- **优点**：余额集中，方便提现

## 注意事项

1. **自动过滤**：系统会自动过滤掉发送人自己，避免循环转账
2. **轮询选择**：如果有多个收款人，系统会轮询选择，确保负载均衡
3. **降级机制**：如果当前模式无法找到收款人，会自动降级到系统配置
4. **多级转账**：多级转账功能不受此模式影响，仍使用原有逻辑

## 常见问题

### Q1：如何查看当前使用的是哪种模式？
A：查看 `transfer_config.json` 中的 `transfer_target_mode` 字段，或运行测试脚本。

### Q2：可以动态切换模式吗？
A：可以，修改配置文件后重启程序即可，或使用代码动态设置。

### Q3：如果管理员没有配置收款人会怎样？
A：系统会自动降级到系统配置的收款人。

### Q4：模式1（转给管理员自己）会不会自己转给自己？
A：不会，系统会自动过滤掉发送人自己。

### Q5：三种模式可以混用吗？
A：不可以，同一时间只能使用一种模式，但可以随时切换。

## 更新日志

- **2026-02-04**：新增转账目标模式功能，支持三种模式选择
