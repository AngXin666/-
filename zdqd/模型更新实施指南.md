# 模型更新功能 - 实施指南（纯本地方式）

## 已创建的文件

### 1. 核心模块
- ✅ `src/model_updater.py` - 模型版本管理器（纯本地）
- ✅ `tools/generate_model_version.py` - 生成版本文件工具
- ✅ `模型更新方案.md` - 完整方案文档

### 2. 待修改的文件
- ⏳ `src/model_manager.py` - 支持从外部models目录加载
- ⏳ `src/gui.py` - 添加"模型信息"按钮（可选）
- ⏳ `build_v2.0.6.bat` - 修改构建脚本，不打包模型

## 立即实施步骤

### 步骤1：创建models目录并移动模型文件

```bash
# 1. 创建models目录
mkdir models

# 2. 移动模型文件
move page_classifier_pytorch_best.pth models\
move page_classes.json models\
move yolo_model_registry.json models\
move page_yolo_mapping.json models\

# 3. 移动YOLO模型目录
move yolo_runs models\
move runs models\

# 4. 生成版本文件（可选）
python tools/generate_model_version.py --version 1.0.0 --description "初始版本"
```

### 步骤2：修改model_manager.py

在 `src/model_manager.py` 的 `__init__` 方法中添加：

```python
def __init__(self):
    # ... 现有代码 ...
    
    # 确定模型目录
    if getattr(sys, 'frozen', False):
        # 打包后的EXE环境
        self.base_dir = Path(sys.executable).parent
    else:
        # 开发环境
        self.base_dir = Path(__file__).parent.parent
    
    # 模型目录（外置）
    self.models_dir = self.base_dir / "models"
    
    # 确保模型目录存在
    if not self.models_dir.exists():
        raise FileNotFoundError(
            f"模型目录不存在: {self.models_dir}\n"
            f"请确保 models 文件夹与程序在同一目录下"
        )
```

然后修改所有模型加载路径，例如：

```python
# 修改前
model_path = "page_classifier_pytorch_best.pth"

# 修改后
model_path = self.models_dir / "page_classifier_pytorch_best.pth"
```

### 步骤3：在GUI中添加模型信息按钮（可选）

在 `src/gui.py` 的配置区域添加按钮：

```python
# 在配置区域的最后添加
row_tools = ttk.Frame(config_frame)
row_tools.pack(fill=tk.X, pady=2)
ttk.Label(row_tools, text="工具:", width=12).pack(side=tk.LEFT)
ttk.Button(row_tools, text="📊 模型信息", command=self._show_model_info, width=12).pack(side=tk.LEFT)
```

然后添加对应的方法：

```python
def _show_model_info(self):
    """显示模型版本信息"""
    try:
        from .model_updater import ModelVersionManager
        from pathlib import Path
        import sys
        
        # 确定models目录
        if getattr(sys, 'frozen', False):
            models_dir = Path(sys.executable).parent / "models"
        else:
            models_dir = Path(__file__).parent.parent / "models"
        
        # 创建版本管理器
        manager = ModelVersionManager(models_dir)
        
        # 获取格式化的版本信息
        info_text = manager.get_formatted_info()
        
        # 创建新窗口显示信息
        info_window = tk.Toplevel(self.root)
        info_window.title("模型版本信息")
        info_window.geometry("600x500")
        
        # 添加文本框
        from tkinter import scrolledtext
        text = scrolledtext.ScrolledText(
            info_window, 
            wrap=tk.WORD,
            font=("Consolas", 9)
        )
        text.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        text.insert(tk.END, info_text)
        text.config(state=tk.DISABLED)
        
        # 添加关闭按钮
        ttk.Button(
            info_window, 
            text="关闭", 
            command=info_window.destroy
        ).pack(pady=10)
    
    except Exception as e:
        from tkinter import messagebox
        messagebox.showerror("错误", f"获取模型信息失败: {e}")
```

### 步骤4：修改构建脚本

修改 `build_v2.0.6.bat`，不再打包模型文件：

```bat
echo [4/7] 开始构建 EXE...
echo 注意: 模型文件不打包到EXE中，需要单独分发
echo.

pyinstaller --onefile --windowed ^
  --name="自动签到助手_v2.0.6" ^
  --add-data "C:\Program Files\Python311\Lib\site-packages\rapidocr;rapidocr" ^
  --add-data "dist/JT;dist/JT" ^
  run.py

REM 不再添加 --add-data "models;models"
```

然后在构建脚本末尾添加：

```bat
echo [8/7] 复制models目录...
if exist "models" (
    xcopy /E /I /Y /Q "models" "dist\models" >nul
    echo ✅ models 目录已复制到 dist
) else (
    echo ⚠️  警告: models 目录不存在
)
echo.

echo [9/7] 创建发布包...
if not exist "release" mkdir "release"

REM 创建发布包目录
set release_dir=release\自动签到助手_v2.0.6
if exist "%release_dir%" rmdir /s /q "%release_dir%"
mkdir "%release_dir%"

REM 复制文件
copy /Y "dist\自动签到助手_v2.0.6.exe" "%release_dir%\" >nul
xcopy /E /I /Y /Q "dist\models" "%release_dir%\models" >nul
copy /Y ".env.example" "%release_dir%\.env.example" >nul
echo 13800138000----password123 > "%release_dir%\账号.txt.example"

REM 创建README
echo 自动签到助手 v2.0.6 > "%release_dir%\README.txt"
echo. >> "%release_dir%\README.txt"
echo 使用说明: >> "%release_dir%\README.txt"
echo 1. 将 .env.example 重命名为 .env >> "%release_dir%\README.txt"
echo 2. 将 账号.txt.example 重命名为 账号.txt 并填写账号信息 >> "%release_dir%\README.txt"
echo 3. 运行 自动签到助手_v2.0.6.exe >> "%release_dir%\README.txt"
echo. >> "%release_dir%\README.txt"
echo 注意: models 文件夹包含所有模型文件，请勿删除 >> "%release_dir%\README.txt"

echo ✅ 发布包已创建: %release_dir%
echo.
```

### 步骤5：测试

1. **开发环境测试**
   ```bash
   # 运行程序，确保能从models目录加载模型
   python run.py
   ```

2. **生成版本文件测试**
   ```bash
   # 生成版本文件
   python tools/generate_model_version.py --version 1.0.0
   
   # 检查生成的文件
   type models\model_version.json
   ```

3. **构建测试**
   ```bash
   # 构建EXE
   build_v2.0.6.bat
   
   # 检查dist目录结构
   dir dist /s
   
   # 运行EXE测试
   cd dist
   自动签到助手_v2.0.6.exe
   ```

## 后续计划

### 模型更新流程（纯手动方式）

1. **训练新模型**
   ```bash
   # 训练完成后
   python train_xxx_yolo.py
   ```

2. **整理新模型文件**
   ```bash
   # 创建新版本目录
   mkdir models_v1.0.1
   
   # 复制所有模型文件
   xcopy /E /I /Y models models_v1.0.1
   
   # 替换更新的模型
   copy runs\detect\yolo_runs\xxx\weights\best.pt models_v1.0.1\yolo_runs\xxx\weights\
   
   # 更新版本信息
   cd models_v1.0.1
   python ..\tools\generate_model_version.py --version 1.0.1 --description "更新xxx模型"
   ```

3. **打包模型更新包**
   ```bash
   # 压缩models文件夹
   powershell Compress-Archive -Path models_v1.0.1 -DestinationPath models_update_v1.0.1.zip
   
   # 创建更新说明
   echo 模型更新包 v1.0.1 > models_update_v1.0.1\更新说明.txt
   echo. >> models_update_v1.0.1\更新说明.txt
   echo 更新内容: >> models_update_v1.0.1\更新说明.txt
   echo - 更新xxx检测模型 >> models_update_v1.0.1\更新说明.txt
   echo. >> models_update_v1.0.1\更新说明.txt
   echo 使用方法: >> models_update_v1.0.1\更新说明.txt
   echo 1. 关闭程序 >> models_update_v1.0.1\更新说明.txt
   echo 2. 备份旧的models文件夹（可选） >> models_update_v1.0.1\更新说明.txt
   echo 3. 用新的models文件夹替换旧的 >> models_update_v1.0.1\更新说明.txt
   echo 4. 重启程序 >> models_update_v1.0.1\更新说明.txt
   ```

4. **发布给用户**
   - 将 `models_update_v1.0.1.zip` 发送给用户
   - 用户按照更新说明操作

### 用户更新步骤

1. **下载模型更新包**
2. **关闭程序**
3. **备份旧模型**（可选）
   ```bash
   rename models models_backup_20260130
   ```
4. **解压新模型**
   - 将新的models文件夹解压到程序目录
5. **重启程序**

### 如果更新后有问题（回滚）

1. **关闭程序**
2. **删除新模型**
   ```bash
   rmdir /s /q models
   ```
3. **恢复备份**
   ```bash
   rename models_backup_20260130 models
   ```
4. **重启程序**

## 常见问题

### Q1: 用户反馈"找不到模型文件"
**A:** 确保发布包包含完整的models目录，并提醒用户不要删除该目录。

### Q2: 模型更新后程序崩溃
**A:** 实现版本兼容性检查，确保模型版本与程序版本匹配。

### Q3: 模型文件太大，下载慢
**A:** 考虑使用CDN加速，或提供分地区的下载服务器。

### Q4: 如何回滚到旧版本模型
**A:** 保留旧版本的model_version.json，提供"恢复到指定版本"功能。

## 总结

这个方案的核心优势：
- ✅ **简单**：只需将模型文件放到models目录
- ✅ **灵活**：可以随时更新模型，无需重新打包EXE
- ✅ **可扩展**：后续可以添加自动更新功能
- ✅ **用户友好**：清晰的目录结构，易于理解

立即开始实施步骤1-5，完成基础的模型外置功能！
