# 性能测试指南

## 概述

本指南说明如何运行启动和导航性能优化的完整测试套件。

## 测试架构

```
tests/
├── performance/
│   ├── test_startup_navigation_performance.py  # 主性能测试套件
│   ├── performance_comparison.py               # 性能对比分析工具
│   └── README.md                                # 详细说明文档
├── integration/
│   └── test_functional_verification.py         # 功能验证测试
└── ...
```

## 测试流程

### 阶段1：性能基准测试

运行性能测试套件，收集以下数据：
- 页面检测速度（模板匹配 vs OCR）
- 缓存有效性
- 导航性能
- 启动流程性能

```bash
python test_performance_quick.py
```

### 阶段2：性能对比分析

测试完成后，自动生成性能对比报告：
- 对比优化前后的性能数据
- 计算性能提升百分比
- 分析各优化点的贡献度
- 评估是否达到性能目标

报告文件：`performance_comparison_report_YYYYMMDD_HHMMSS.txt`

### 阶段3：功能验证

验证优化后的功能是否正常工作：
- 页面识别准确性
- 弹窗关闭功能
- 广告页处理
- 导航功能

```bash
python -m tests.integration.test_functional_verification
```

## 预期结果

### 性能目标

| 指标 | 优化前 | 优化后目标 | 预期提升 |
|------|--------|-----------|---------|
| 启动流程 | 30-60秒 | < 15秒 | 50-75% |
| 导航到个人页 | 10-15秒 | < 3秒 | 70-80% |
| 模板匹配检测 | N/A | < 0.1秒 | 10-20x |
| OCR识别 | 1-3秒 | < 2秒 | 保持 |

### 功能验证

所有功能应保持正常工作：
- ✓ 页面识别准确性 ≥ 80%
- ✓ 弹窗能正确关闭
- ✓ 广告页能正确识别和处理
- ✓ 导航功能正常（100%成功率）

## 测试示例

### 示例1：完整性能测试

```bash
$ python test_performance_quick.py

================================================================================
启动和导航性能快速测试
================================================================================

配置:
  设备ID: 127.0.0.1:16384
  应用包名: com.ry.xmsc

提示:
  - 请确保模拟器已启动
  - 请确保应用已安装
  - 测试将自动运行所有性能测试

按 Enter 键开始测试...

[10:30:15] 正在连接设备...
[10:30:15] ✓ 已连接到设备: 127.0.0.1:16384

================================================================================
启动和导航性能测试套件
================================================================================

[10:30:16] ================================================================================
[10:30:16] 测试：页面检测速度（10次迭代）
[10:30:16] ================================================================================
[10:30:16]   迭代 1/10 - 模板匹配: 0.085秒, 结果: HOME
[10:30:16]   迭代 1/10 - OCR识别: 1.523秒, 结果: HOME
...

[10:30:25] 测试结果:
[10:30:25]   平均模板匹配耗时: 0.082 秒
[10:30:25]   平均OCR识别耗时: 1.547 秒
[10:30:25]   速度提升: 18.9x
[10:30:25]   模板匹配达标: ✓ (目标 < 0.1秒)
[10:30:25]   OCR识别达标: ✓ (目标 < 2.0秒)

...

================================================================================
性能对比分析报告
================================================================================

生成时间: 2026-01-20 10:35:42

【1. 启动流程性能】

  优化前基准: 45.0 秒
  优化后实际: 12.5 秒
  性能目标:   < 15.0 秒
  性能提升:   72.2%
  节省时间:   32.5 秒
  达标状态:   ✓ 达标

【2. 导航性能】

  优化前基准: 12.5 秒
  优化后实际: 2.3 秒
  性能目标:   < 3.0 秒
  性能提升:   81.6%
  节省时间:   10.2 秒
  达标状态:   ✓ 达标

...

【6. 结论】

  ✓ 性能优化目标基本达成
  ✓ 大部分指标达到或超过预期目标

================================================================================

报告已保存到: performance_comparison_report_20260120_103542.txt

================================================================================
测试完成！
================================================================================
```

### 示例2：功能验证测试

```bash
$ python -m tests.integration.test_functional_verification

[10:40:15] 连接设备...
[10:40:15] ✓ 已连接到设备: 127.0.0.1:16384

================================================================================
功能验证测试套件
================================================================================

[10:40:16] ================================================================================
[10:40:16] 测试：页面识别准确性（5次迭代）
[10:40:16] ================================================================================
[10:40:16] 迭代 1/5
[10:40:16]   模板匹配: HOME (置信度: 0.95)
[10:40:16]   OCR识别: HOME (置信度: 0.92)
[10:40:16]   一致性: ✓
...

[10:40:25] 测试结果:
[10:40:25]   一致性: 5/5 (100.0%)
[10:40:25]   成功: ✓

...

================================================================================
功能验证汇总
================================================================================

✓ 页面识别准确性: 成功
⊘ 弹窗关闭功能: 跳过 (当前不是弹窗页面)
✓ 广告页检测: 成功
✓ 导航功能: 成功

总体成功率: 3/3 (100.0%)

[10:40:45] 测试完成
```

## 常见问题

### Q1: 测试失败怎么办？

A: 首先检查：
1. 模拟器是否正常运行
2. 应用是否正确安装
3. 网络连接是否正常
4. 查看详细错误日志

### Q2: 性能未达标怎么办？

A: 分析性能报告：
1. 查看哪些指标未达标
2. 检查是否有异常耗时的步骤
3. 查看缓存命中率
4. 考虑进一步优化

### Q3: 如何调试测试？

A: 启用调试模式：
```python
# 在测试脚本中设置
enable_debug=True  # 启用调试日志
```

调试日志保存在 `debug_logs/session_YYYYMMDD_HHMMSS/`

### Q4: 如何修改测试参数？

A: 编辑测试脚本中的配置：
```python
# test_startup_navigation_performance.py
iterations = 10  # 修改迭代次数
max_wait_time = 60  # 修改最大等待时间
```

## 最佳实践

1. **测试前准备**
   - 确保模拟器性能稳定
   - 关闭其他占用资源的应用
   - 确保网络连接稳定

2. **测试执行**
   - 按顺序运行测试（性能测试 → 功能验证）
   - 每次测试前重启应用
   - 记录测试环境信息

3. **结果分析**
   - 对比多次测试结果
   - 关注性能波动
   - 分析异常情况

4. **持续改进**
   - 定期运行测试
   - 跟踪性能趋势
   - 及时发现性能退化

## 相关文档

- [性能测试README](README.md) - 详细的测试说明
- [需求文档](../../.kiro/specs/startup-navigation-performance/requirements.md) - 性能需求
- [设计文档](../../.kiro/specs/startup-navigation-performance/design.md) - 优化设计
- [任务列表](../../.kiro/specs/startup-navigation-performance/tasks.md) - 实现任务
